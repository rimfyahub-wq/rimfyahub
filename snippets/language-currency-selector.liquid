{% comment %}
  Language and Currency Selector
  Usage: {% render 'language-currency-selector', location: 'header' %}
{% endcomment %}

{% assign show_language = settings.show_language_selector %}
{% assign show_currency = settings.show_currency_selector %}
{% assign selector_style = settings.selector_style %}
{% assign selector_position = settings.selector_position %}
{% assign location = location | default: 'header' %}

{% comment %} Only show if position matches {% endcomment %}
{% if selector_position == location or selector_position == 'both' %}
  {% if show_language or show_currency %}
    <div class="locale-selector {% if location == 'header' %}locale-selector--header{% else %}locale-selector--footer{% endif %}">
      
      {% comment %} Language Selector {% endcomment %}
      {% if show_language %}
        {% if localization.available_languages.size > 1 %}
          <div class="locale-selector__item">
            {% form 'localization', class: 'locale-form', id: 'localization_form_language' %}
              <button type="button" class="locale-button" onclick="toggleLocaleDropdown('language')">
                {% if selector_style == 'flags' %}
                  <span class="locale-flag">{{ localization.language.iso_code | upcase }}</span>
                {% endif %}
                <span class="locale-text">{{ localization.language.endonym_name }}</span>
                <svg class="locale-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M2 4L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </button>
              
              <div class="locale-dropdown" id="language-dropdown" style="display: none;">
                {% for language in localization.available_languages %}
                  <button 
                    type="submit" 
                    name="language_code" 
                    value="{{ language.iso_code }}"
                    class="locale-option {% if language.iso_code == localization.language.iso_code %}locale-option--active{% endif %}"
                  >
                    {% if selector_style == 'flags' %}
                      <span class="locale-flag">{{ language.iso_code | upcase }}</span>
                    {% endif %}
                    <span>{{ language.endonym_name }}</span>
                    {% if language.iso_code == localization.language.iso_code %}
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M13 4L6 11L3 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    {% endif %}
                  </button>
                {% endfor %}
              </div>
            {% endform %}
          </div>
        {% else %}
          {% comment %} Show placeholder when no languages set up {% endcomment %}
          <div class="locale-selector__item">
            <div class="locale-button locale-button--placeholder">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
              </svg>
              <span class="locale-text">English</span>
            </div>
          </div>
        {% endif %}
      {% endif %}
            <button type="button" class="locale-button" onclick="toggleLocaleDropdown('language')">
              {% if selector_style == 'flags' %}
                <span class="locale-flag">{{ localization.language.iso_code | upcase }}</span>
              {% endif %}
              <span class="locale-text">{{ localization.language.endonym_name }}</span>
              <svg class="locale-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                <path d="M2 4L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
            </button>
            
            <div class="locale-dropdown" id="language-dropdown" style="display: none;">
              {% for language in localization.available_languages %}
                <button 
                  type="submit" 
                  name="language_code" 
                  value="{{ language.iso_code }}"
                  class="locale-option {% if language.iso_code == localization.language.iso_code %}locale-option--active{% endif %}"
                >
                  {% if selector_style == 'flags' %}
                    <span class="locale-flag">{{ language.iso_code | upcase }}</span>
                  {% endif %}
                  <span>{{ language.endonym_name }}</span>
                  {% if language.iso_code == localization.language.iso_code %}
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M13 4L6 11L3 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  {% endif %}
                </button>
              {% endfor %}
            </div>
          {% endform %}
        </div>
      {% endif %}

      {% comment %} Currency Selector {% endcomment %}
      {% if show_currency %}
        {% if localization.available_countries.size > 1 %}
          <div class="locale-selector__item">
            {% form 'localization', class: 'locale-form', id: 'localization_form_currency' %}
              <button type="button" class="locale-button" onclick="toggleLocaleDropdown('currency')">
                <span class="locale-text">{{ localization.country.currency.iso_code }} {{ localization.country.currency.symbol }}</span>
                <svg class="locale-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M2 4L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </button>
              
              <div class="locale-dropdown" id="currency-dropdown" style="display: none;">
                {% for country in localization.available_countries %}
                  <button 
                    type="submit" 
                    name="country_code" 
                    value="{{ country.iso_code }}"
                    class="locale-option {% if country.iso_code == localization.country.iso_code %}locale-option--active{% endif %}"
                  >
                    <span>{{ country.currency.iso_code }} {{ country.currency.symbol }}</span>
                    <span class="locale-option__country">{{ country.name }}</span>
                    {% if country.iso_code == localization.country.iso_code %}
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M13 4L6 11L3 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    {% endif %}
                  </button>
                {% endfor %}
              </div>
            {% endform %}
          </div>
        {% else %}
          {% comment %} Show placeholder when no currencies set up {% endcomment %}
          <div class="locale-selector__item">
            <div class="locale-button locale-button--placeholder">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
              </svg>
              <span class="locale-text">USD $</span>
            </div>
          </div>
        {% endif %}
      {% endif %}
        <div class="locale-selector__item">
          {% form 'localization', class: 'locale-form', id: 'localization_form_currency' %}
            <button type="button" class="locale-button" onclick="toggleLocaleDropdown('currency')">
              <span class="locale-text">{{ localization.country.currency.iso_code }} {{ localization.country.currency.symbol }}</span>
              <svg class="locale-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                <path d="M2 4L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
            </button>
            
            <div class="locale-dropdown" id="currency-dropdown" style="display: none;">
              {% for country in localization.available_countries %}
                <button 
                  type="submit" 
                  name="country_code" 
                  value="{{ country.iso_code }}"
                  class="locale-option {% if country.iso_code == localization.country.iso_code %}locale-option--active{% endif %}"
                >
                  <span>{{ country.currency.iso_code }} {{ country.currency.symbol }}</span>
                  <span class="locale-option__country">{{ country.name }}</span>
                  {% if country.iso_code == localization.country.iso_code %}
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M13 4L6 11L3 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  {% endif %}
                </button>
              {% endfor %}
            </div>
          {% endform %}
        </div>
      {% endif %}
    </div>
  {% endif %}
{% endif %}

<style>
  .locale-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .locale-selector--header {
    margin-right: 1rem;
  }

  .locale-selector--footer {
    justify-content: center;
    flex-wrap: wrap;
    gap: 1rem;
    padding: 1rem 0;
  }

  .locale-selector__item {
    position: relative;
  }

  .locale-form {
    margin: 0;
  }

  .locale-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: rgba(255, 255, 255, 0.9);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.875rem;
  }

  .locale-button:hover {
    background: rgba(0, 229, 255, 0.1);
    border-color: rgba(0, 229, 255, 0.3);
    color: hsl(193, 100%, 65%);
  }

  .locale-button--placeholder {
    opacity: 0.6;
    cursor: default;
    pointer-events: none;
  }

  .locale-flag {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: rgba(0, 229, 255, 0.2);
    border-radius: 4px;
    font-size: 0.625rem;
    font-weight: 600;
    color: hsl(193, 100%, 65%);
  }

  .locale-text {
    font-size: 0.875rem;
  }

  .locale-icon {
    transition: transform 0.2s ease;
  }

  .locale-button[aria-expanded="true"] .locale-icon {
    transform: rotate(180deg);
  }

  .locale-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 200px;
    background: rgba(10, 10, 10, 0.98);
    border: 1px solid rgba(0, 229, 255, 0.3);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(20px);
    padding: 0.5rem;
    z-index: 1000;
    max-height: 400px;
    overflow-y: auto;
  }

  .locale-selector--footer .locale-dropdown {
    bottom: calc(100% + 0.5rem);
    top: auto;
  }

  .locale-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.75rem;
    background: transparent;
    border: none;
    border-radius: 8px;
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    font-size: 0.875rem;
  }

  .locale-option:hover {
    background: rgba(0, 229, 255, 0.1);
    color: hsl(193, 100%, 65%);
  }

  .locale-option--active {
    background: rgba(0, 229, 255, 0.15);
    color: hsl(193, 100%, 65%);
  }

  .locale-option svg {
    margin-left: auto;
    stroke: hsl(193, 100%, 65%);
  }

  .locale-option__country {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
    margin-left: auto;
  }

  /* Scrollbar Styling */
  .locale-dropdown::-webkit-scrollbar {
    width: 6px;
  }

  .locale-dropdown::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
  }

  .locale-dropdown::-webkit-scrollbar-thumb {
    background: rgba(0, 229, 255, 0.3);
    border-radius: 3px;
  }

  .locale-dropdown::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 229, 255, 0.5);
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .locale-selector--header {
      margin-right: 0.5rem;
    }

    .locale-button {
      padding: 0.4rem 0.6rem;
      font-size: 0.8125rem;
    }

    .locale-text {
      display: none;
    }

    .locale-flag {
      width: 24px;
      height: 24px;
    }
  }
</style>

<script>
  function toggleLocaleDropdown(type) {
    const dropdown = document.getElementById(type + '-dropdown');
    const button = dropdown.previousElementSibling;
    const isOpen = dropdown.style.display === 'block';
    
    // Close all dropdowns
    document.querySelectorAll('.locale-dropdown').forEach(dd => {
      dd.style.display = 'none';
    });
    
    // Reset all buttons
    document.querySelectorAll('.locale-button').forEach(btn => {
      btn.setAttribute('aria-expanded', 'false');
    });
    
    // Toggle current dropdown
    if (!isOpen) {
      dropdown.style.display = 'block';
      button.setAttribute('aria-expanded', 'true');
    }
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.locale-selector__item')) {
      document.querySelectorAll('.locale-dropdown').forEach(dropdown => {
        dropdown.style.display = 'none';
      });
      document.querySelectorAll('.locale-button').forEach(btn => {
        btn.setAttribute('aria-expanded', 'false');
      });
    }
  });
</script>
