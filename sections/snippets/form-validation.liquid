{% comment %}
  Form Validation Component
  Provides client-side validation with accessibility support
  Usage: {% render 'form-validation' %}
{% endcomment %}

<script>
/**
 * Form Validation Handler
 * Provides real-time validation feedback with accessibility
 */
class FormValidator {
  constructor() {
    this.forms = document.querySelectorAll('[data-form-validate]');
    this.init();
  }

  init() {
    try {
      this.forms.forEach(form => {
        this.attachValidation(form);
      });
    } catch (error) {
      console.error('Form validation initialization error:', error);
    }
  }

  attachValidation(form) {
    try {
      const inputs = form.querySelectorAll('input, textarea, select');
      
      inputs.forEach(input => {
        // Real-time validation on change
        input.addEventListener('blur', () => this.validateField(input));
        input.addEventListener('change', () => this.validateField(input));
        
        // Clear error on input
        input.addEventListener('input', () => {
          if (input.classList.contains('error')) {
            this.clearFieldError(input);
          }
        });
      });

      // Form submission validation
      form.addEventListener('submit', (e) => {
        if (!this.validateForm(form)) {
          e.preventDefault();
        }
      });
    } catch (error) {
      console.error('Form attachment error:', error);
    }
  }

  validateField(field) {
    try {
      const value = field.value.trim();
      const type = field.type;
      const required = field.hasAttribute('required');
      let isValid = true;

      // Check required
      if (required && value === '') {
        isValid = false;
        this.showFieldError(field, 'This field is required');
        return;
      }

      // Type-specific validation
      if (value !== '') {
        switch (type) {
          case 'email':
            isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
            if (!isValid) {
              this.showFieldError(field, 'Please enter a valid email');
            }
            break;
          
          case 'tel':
            isValid = /^[\d\s\-\+\(\)]+$/.test(value) && value.length >= 10;
            if (!isValid) {
              this.showFieldError(field, 'Please enter a valid phone number');
            }
            break;
          
          case 'url':
            try {
              new URL(value);
            } catch {
              isValid = false;
              this.showFieldError(field, 'Please enter a valid URL');
            }
            break;
          
          case 'number':
            isValid = !isNaN(value);
            if (!isValid) {
              this.showFieldError(field, 'Please enter a valid number');
            }
            break;
        }
      }

      if (isValid) {
        this.clearFieldError(field);
      }

      return isValid;
    } catch (error) {
      console.error('Field validation error:', error);
      return true;
    }
  }

  validateForm(form) {
    try {
      const inputs = form.querySelectorAll('input, textarea, select');
      let isValid = true;

      inputs.forEach(input => {
        if (!this.validateField(input)) {
          isValid = false;
        }
      });

      return isValid;
    } catch (error) {
      console.error('Form validation error:', error);
      return true;
    }
  }

  showFieldError(field, message) {
    try {
      // Remove existing error message
      this.clearFieldError(field);

      // Add error class
      field.classList.add('error');
      field.setAttribute('aria-invalid', 'true');

      // Create error message element
      const errorMsg = document.createElement('div');
      errorMsg.className = 'form-error-message';
      errorMsg.setAttribute('role', 'alert');
      errorMsg.textContent = message;

      // Insert error message after field
      field.parentNode.insertBefore(errorMsg, field.nextSibling);

      // Link error message to field for accessibility
      const msgId = `error-${field.id || field.name}-${Date.now()}`;
      errorMsg.id = msgId;
      field.setAttribute('aria-describedby', msgId);
    } catch (error) {
      console.error('Error showing field error:', error);
    }
  }

  clearFieldError(field) {
    try {
      field.classList.remove('error');
      field.setAttribute('aria-invalid', 'false');
      
      const errorMsg = field.parentNode.querySelector('.form-error-message');
      if (errorMsg) {
        errorMsg.remove();
      }

      field.removeAttribute('aria-describedby');
    } catch (error) {
      console.error('Error clearing field error:', error);
    }
  }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    new FormValidator();
  });
} else {
  new FormValidator();
}
</script>

<style>
  /* Form field styling */
  input[type="text"],
  input[type="email"],
  input[type="tel"],
  input[type="url"],
  input[type="number"],
  input[type="password"],
  textarea,
  select {
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  input[type="text"]:focus,
  input[type="email"]:focus,
  input[type="tel"]:focus,
  input[type="url"]:focus,
  input[type="number"]:focus,
  input[type="password"]:focus,
  textarea:focus,
  select:focus {
    border-color: hsl(193, 100%, 65%);
    box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.1);
    outline: none;
  }

  /* Error state styling */
  input.error,
  textarea.error,
  select.error {
    border-color: #ff4444;
    background: rgba(255, 68, 68, 0.05);
  }

  input.error:focus,
  textarea.error:focus,
  select.error:focus {
    box-shadow: 0 0 0 3px rgba(255, 68, 68, 0.1);
  }

  /* Error message styling */
  .form-error-message {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: rgba(255, 68, 68, 0.1);
    border-left: 3px solid #ff4444;
    color: #ff7777;
    font-size: 0.875rem;
    border-radius: 0.25rem;
    animation: slideIn 0.2s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-0.5rem);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Accessibility focus visible */
  input:focus-visible,
  textarea:focus-visible,
  select:focus-visible {
    outline: 2px solid hsl(193, 100%, 65%);
    outline-offset: 2px;
  }
</style>
